<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>FMC150 Live Tracker</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
        }

        #map {
            width: 40%;
            height: 100%;
        }

        #info {
            flex: 1;
            padding: 16px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
        }

        .row {
            font-size: 14px;
            margin-bottom: 6px;
        }

        .label {
            font-weight: bold;
        }

        .control {
            margin-bottom: 12px;
        }

        input {
            width: 80px;
            padding: 4px;
        }

        button {
            padding: 4px 8px;
            margin-left: 6px;
            cursor: pointer;
        }

        .trip {
            border: 1px solid #ccc;
            padding: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .trip:hover {
            background: #f5f5f5;
        }

        nav {
            display: flex;
            gap: 10px;
            /* space between buttons */
            padding: 10px;
        }

        nav button {
            background-color: #4CAF50;
            /* green */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        nav button:hover {
            background-color: #45a049;
            /* darker green on hover */
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div id="info">
        <nav>
            <button onclick="location.href='index.html'">Home</button>
            <button onclick="location.href='trips.html'">Trips</button>
        </nav>
        <h2>FMC150 Device Data</h2>

        <div class="control">
            <span class="label">Refresh (sec):</span>
            <input id="refreshInput" type="number" value="10" min="1" />
            <button onclick="applyRefreshRate()">Apply</button>
        </div>

        <div id="data">Loading…</div>

        <hr />
        <div class="row">
            <span class="label">Last update:</span>
            <span id="lastUpdate">–</span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_URL = "https://12byiwuq21.execute-api.us-east-1.amazonaws.com/ProductionApi";

        let map;
        let marker;
        let poller;
        let refreshRateSec = 10;

        const SQLcommand = JSON.stringify({
            body: "SELECT * FROM tracker_data WHERE DeviceId = 2147483647 ORDER BY timestamp DESC LIMIT 1;"
        });

        async function fetchDeviceData() {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: SQLcommand
            });

            const result = await response.json();
            return result.body[0];
        }

        function updateInfoPanel(data) {
            const container = document.getElementById("data");
            container.innerHTML = "";

            Object.entries(data).forEach(([key, value]) => {
                const row = document.createElement("div");
                row.className = "row";
                row.innerHTML = `<span class="label">${key}:</span> ${value}`;
                container.appendChild(row);
            });

            document.getElementById("lastUpdate").innerText =
                new Date(data.timestamp).toLocaleString();
        }

        function updateMap(data) {
            const lat = parseFloat(data.latitude);
            const lng = parseFloat(data.longitude);

            if (!map) {
                map = L.map("map").setView([lat, lng], 15);

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "© OpenStreetMap"
                }).addTo(map);

                marker = L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup(`Device ${data.DeviceId}`)
                    .openPopup();
            } else {
                marker.setLatLng([lat, lng]);
                map.panTo([lat, lng]);
            }
        }

        async function refresh() {
            try {
                const data = await fetchDeviceData();
                updateInfoPanel(data);
                updateMap(data);
            } catch (err) {
                console.error("Refresh failed", err);
            }
        }

        function startPolling() {
            refresh();
            poller = setInterval(refresh, refreshRateSec * 1000);
        }

        function applyRefreshRate() {
            const input = Number(document.getElementById("refreshInput").value);

            if (isNaN(input) || input < 1) {
                alert("Please enter a valid number (>= 1 second)");
                return;
            }

            refreshRateSec = input;
            clearInterval(poller);
            startPolling();
        }

        window.onload = startPolling;
    </script>

</body>

</html>